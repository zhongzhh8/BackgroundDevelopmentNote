# 第十一章

进程间通信方法：管道、消息队列、共享内存、信号量。

## 11.1 管道

管道的特点：

- 数据单向传输，是半双工通道，在同一时刻只能单向通信，如果想要全双工通信，就需要两个管道。
- 只能用于父子进程或者兄弟进程间通信。

管道两端用描述字fd[0]和fd[1]表示，fd[0]是管道读端，只能读，fd[1]是管道写端，只能写。

**无名管道**实现父子进程间的通信，由于都是同一份代码，在代码中创建管道，

- 实现“子写父读”：在子进程部分关闭读端fd[0]，然后往写端fd[1]写数据；父进程部分关闭写端fd[1]，然后往读端fd[0]读数据。
- 实现“子读父写”：同理类推。

可见无名管道是在代码中创建的，所以只有父子进程或者兄弟进程才能访问到这个管道。为了让没有关联的进程间也能访问管道，就有了有名管道。

**有名管道**创建在文件系统中，有一个对应的路径名，因此没有关联的进程都可以访问。



## 11.2 消息队列

这部分我感觉作者写的消息队列，跟网上所讲的消息队列不一样。

**书本上的消息队列**是进程间的通信，是微观的：

通信双方进程都要创建消息队列（设置相同的键值），优点是可以让没有亲缘关系的进程通信、不用考虑同步问题。但是实话说，好像没有什么特别的。

**网上的消息队列**往往是比较具体的应用间的通信方式，是宏观的：

使用消息队列的好处：

1. 异步。生产者把消息交给消息队列后可以直接去处理其他事务，不需要等待消费者读取信息。从而提高生产者性能。
2. 削峰：通过异步处理，将短时间高并发产生的事务消息存储在消息队列中，从而削平高峰期的并发事务。
3. 解耦。事务分离，生产者只需要专注生产消息，由消息队列来负责消息分发（比如重发之类的麻烦事情）。

12306就是这样的，订票、付款之后就得到响应，然后后台系统再慢慢处理请求，过一会儿才发来信息说订票成功。



## 11.3 共享内存

共享内存就是通过共享一块内存来通信。共享内存的缺点是没有同步机制，一个进程写共享内存时无法阻止其他进程读这块内存。因此共享内存需要配合其他同步机制（比如信号量）来实现进程通信。

具体代码就不讲了，主要的步骤是：

1. 创建共享内存（通信双方用相同的键值来创建）。
2. 映射共享内存到进程的地址空间去。
3. 进程读或者写这块内存。
4. 分离进程与共享内存。
5. 删除共享内存。



## 11.4 信号量

其实是信号量搭配共享内存通信，实际上还是通过共享内存来传输数据。双方创建的共享内存和信号量都要用相同的键值。没什么好讲的。



## 11.5 ipcs命令

ipcs命令用于报告系统的消息队列、信号量、共享内存状信息。

```shell
ipcs -a  #列出所有消息队列、信号量、共享内存的信息
ipcs -q #列出所有消息队列信息
ipcs -s	#列出所有信息量信息
ipcs -m	#列出所有共享内存信息 
```

